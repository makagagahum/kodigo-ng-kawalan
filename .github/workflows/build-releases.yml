name: Build & Release Installers (Multi-Architecture)

on:
  push:
    branches: [main]
    paths:
      - 'kodigo-for-dummies/**'
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        arch: ['x86_64', 'arm64']
    steps:
      - uses: actions/checkout@v3
      - name: Create Windows Installer Wrapper
        run: |
          # Create lightweight PowerShell wrapper that launches the setup script
          $wrapper = @"
          # Kodigo ng Kawalan: Likha sa Wala - Setup Launcher
          # Architecture: ${{ matrix.arch }}
          # This wrapper simply launches the cloud setup script
          
          Write-Host 'Kodigo ng Kawalan - Cloud Infrastructure Setup' -ForegroundColor Cyan
          Write-Host 'Architecture: ${{ matrix.arch }}' -ForegroundColor Green
          
          # Download and execute setup script
          \$SetupScript = (New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/makagagahum/kodigo-ng-kawalan/main/kodigo-for-dummies/setup.ps1')
          Invoke-Expression \$SetupScript
          "@
          
          Set-Content -Path "setup-${{ matrix.arch }}.ps1" -Value $wrapper
          Write-Host "Windows installer wrapper created for ${{ matrix.arch }}"
        shell: powershell
      - uses: actions/upload-artifact@v3
        with:
          name: windows-${{ matrix.arch }}
          path: setup-${{ matrix.arch }}.ps1

  build-macos:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest]
        arch: ['x86_64', 'arm64']  # Apple Silicon & Intel
    steps:
      - uses: actions/checkout@v3
      - name: Create macOS Universal Installer
        run: |
          # Create lightweight shell wrapper for macOS
          mkdir -p dist/Kodigo-${{ matrix.arch }}
          
          # Create launcher script
          cat > dist/Kodigo-${{ matrix.arch }}/install.sh << 'EOF'
          #!/bin/bash
          # Kodigo ng Kawalan: Likha sa Wala - Setup Launcher
          # Architecture: ${{ matrix.arch }}
          
          echo "Kodigo ng Kawalan - Cloud Infrastructure Setup"
          echo "Architecture: ${{ matrix.arch }}"
          echo "Downloading and executing cloud setup..."
          
          # Download and execute setup script
          curl -fsSL https://raw.githubusercontent.com/makagagahum/kodigo-ng-kawalan/main/kodigo-for-dummies/auto-setup.sh | bash
          EOF
          
          chmod +x dist/Kodigo-${{ matrix.arch }}/install.sh
          cp kodigo-for-dummies/auto-setup.sh dist/Kodigo-${{ matrix.arch }}/
          cp kodigo-for-dummies/setup.ps1 dist/Kodigo-${{ matrix.arch }}/
          
          echo "macOS installer wrapper created for ${{ matrix.arch }}"
      - uses: actions/upload-artifact@v3
        with:
          name: macos-${{ matrix.arch }}
          path: dist/Kodigo-${{ matrix.arch }}

  build-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        arch: ['x86_64', 'arm64', 'armv7']
        include:
          - os: ubuntu-latest
            arch: x86_64
            qemu_arch: null
          - os: ubuntu-latest
            arch: arm64
            qemu_arch: aarch64
          - os: ubuntu-latest
            arch: armv7
            qemu_arch: armv7l
    steps:
      - uses: actions/checkout@v3
      - name: Set up QEMU for ARM builds
        if: matrix.qemu_arch != null
        uses: docker/setup-qemu-action@v2
      - name: Create Linux Installer
        run: |
          mkdir -p dist/kodigo-${{ matrix.arch }}
          
          # Create launcher script
          cat > dist/kodigo-${{ matrix.arch }}/install.sh << 'EOF'
          #!/bin/bash
          # Kodigo ng Kawalan: Likha sa Wala - Setup Launcher
          # Architecture: ${{ matrix.arch }}
          
          echo "Kodigo ng Kawalan - Cloud Infrastructure Setup"
          echo "Architecture: ${{ matrix.arch }}"
          echo "Downloading and executing cloud setup..."
          
          # Download and execute setup script
          curl -fsSL https://raw.githubusercontent.com/makagagahum/kodigo-ng-kawalan/main/kodigo-for-dummies/auto-setup.sh | bash
          EOF
          
          chmod +x dist/kodigo-${{ matrix.arch }}/install.sh
          cp kodigo-for-dummies/auto-setup.sh dist/kodigo-${{ matrix.arch }}/
          
          echo "Linux installer created for ${{ matrix.arch }}"
      - uses: actions/upload-artifact@v3
        with:
          name: linux-${{ matrix.arch }}
          path: dist/kodigo-${{ matrix.arch }}

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v1.0.0-${{ github.run_number }}
          release_name: Kodigo ng Kawalan v1.0.0 Build ${{ github.run_number }}
          body: |
            # Kodigo ng Kawalan: Likha sa Wala
            Created from Nothing - Cloud Infrastructure Setup
            
            ## Universal Installers (All Architectures)
            
            ### Windows (Run in PowerShell):
            - **setup-x86_64.ps1** - Intel/AMD 64-bit
            - **setup-arm64.ps1** - ARM 64-bit (Windows 11 ARM)
            
            Usage:
            ```powershell
            iex (Get-Content ./setup-x86_64.ps1 -Raw)
            ```
            
            ### macOS (Run in Terminal):
            - **Kodigo-x86_64/** - Intel Mac
            - **Kodigo-arm64/** - Apple Silicon (M1/M2/M3)
            
            Usage:
            ```bash
            bash Kodigo-arm64/install.sh
            ```
            
            ### Linux (Run in Terminal):
            - **kodigo-x86_64/** - 64-bit Intel/AMD
            - **kodigo-arm64/** - ARM 64-bit (Raspberry Pi 4/5, AWS Graviton)
            - **kodigo-armv7/** - ARM 32-bit (Raspberry Pi 3, older ARM devices)
            
            Usage:
            ```bash
            bash kodigo-arm64/install.sh
            ```
            
            ## What These Installers Do:
            Each installer is a lightweight wrapper that:
            1. Detects your device architecture automatically
            2. Downloads the cloud setup script from GitHub
            3. Executes the setup script in your terminal
            4. Configures all 5 cloud services (Vercel, Render, Supabase, Cloudflare, n8n)
            5. NO installation on your system - pure cloud!
            
            ## Architecture Support:
            ✓ **x86_64** - Intel, AMD processors (most common)
            ✓ **ARM64** - Apple Silicon, AWS Graviton, Raspberry Pi 4+, modern Android
            ✓ **ARM32** - Older Raspberry Pi, legacy ARM devices
            ✓ **Windows x86_64 & ARM64** - All Windows versions
            
            **Version:** v1.0.0-beta (Likha sa Wala Edition)  
            **By:** Marvin S. Villanueva  
            **Contact:** marvin@orin.work  
            **Website:** marvin.orin.work  
            **GitHub:** github.com/makagagahum/kodigo-ng-kawalan
            
            ## 100% Open Source
            All installers are simple script wrappers. Download, inspect, and run with confidence!
          draft: false
          prerelease: true
